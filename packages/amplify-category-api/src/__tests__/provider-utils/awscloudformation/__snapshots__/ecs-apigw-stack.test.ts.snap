// Jest Snapshot v1, https://jestjs.io/docs/snapshot-testing

exports[`ecs stack should generate valid CFN template 1`] = `
{
  "Conditions": {
    "isAuthCondition": {
      "Fn::And": [
        {
          "Fn::Equals": [
            false,
            true,
          ],
        },
        {
          "Fn::Not": [
            {
              "Fn::Equals": [
                "",
                "",
              ],
            },
          ],
        },
        {
          "Fn::Not": [
            {
              "Fn::Equals": [
                "",
                "",
              ],
            },
          ],
        },
      ],
    },
  },
  "Mappings": {
    "ServiceprincipalMap": {
      "af-south-1": {
        "states": "states.af-south-1.amazonaws.com",
      },
      "ap-east-1": {
        "states": "states.ap-east-1.amazonaws.com",
      },
      "ap-northeast-1": {
        "states": "states.ap-northeast-1.amazonaws.com",
      },
      "ap-northeast-2": {
        "states": "states.ap-northeast-2.amazonaws.com",
      },
      "ap-northeast-3": {
        "states": "states.ap-northeast-3.amazonaws.com",
      },
      "ap-south-1": {
        "states": "states.ap-south-1.amazonaws.com",
      },
      "ap-south-2": {
        "states": "states.ap-south-2.amazonaws.com",
      },
      "ap-southeast-1": {
        "states": "states.ap-southeast-1.amazonaws.com",
      },
      "ap-southeast-2": {
        "states": "states.ap-southeast-2.amazonaws.com",
      },
      "ap-southeast-3": {
        "states": "states.ap-southeast-3.amazonaws.com",
      },
      "ap-southeast-4": {
        "states": "states.ap-southeast-4.amazonaws.com",
      },
      "ca-central-1": {
        "states": "states.ca-central-1.amazonaws.com",
      },
      "cn-north-1": {
        "states": "states.cn-north-1.amazonaws.com",
      },
      "cn-northwest-1": {
        "states": "states.cn-northwest-1.amazonaws.com",
      },
      "eu-central-1": {
        "states": "states.eu-central-1.amazonaws.com",
      },
      "eu-central-2": {
        "states": "states.eu-central-2.amazonaws.com",
      },
      "eu-north-1": {
        "states": "states.eu-north-1.amazonaws.com",
      },
      "eu-south-1": {
        "states": "states.eu-south-1.amazonaws.com",
      },
      "eu-south-2": {
        "states": "states.eu-south-2.amazonaws.com",
      },
      "eu-west-1": {
        "states": "states.eu-west-1.amazonaws.com",
      },
      "eu-west-2": {
        "states": "states.eu-west-2.amazonaws.com",
      },
      "eu-west-3": {
        "states": "states.eu-west-3.amazonaws.com",
      },
      "il-central-1": {
        "states": "states.il-central-1.amazonaws.com",
      },
      "me-central-1": {
        "states": "states.me-central-1.amazonaws.com",
      },
      "me-south-1": {
        "states": "states.me-south-1.amazonaws.com",
      },
      "sa-east-1": {
        "states": "states.sa-east-1.amazonaws.com",
      },
      "us-east-1": {
        "states": "states.us-east-1.amazonaws.com",
      },
      "us-east-2": {
        "states": "states.us-east-2.amazonaws.com",
      },
      "us-gov-east-1": {
        "states": "states.us-gov-east-1.amazonaws.com",
      },
      "us-gov-west-1": {
        "states": "states.us-gov-west-1.amazonaws.com",
      },
      "us-iso-east-1": {
        "states": "states.amazonaws.com",
      },
      "us-iso-west-1": {
        "states": "states.amazonaws.com",
      },
      "us-isob-east-1": {
        "states": "states.amazonaws.com",
      },
      "us-west-1": {
        "states": "states.us-west-1.amazonaws.com",
      },
      "us-west-2": {
        "states": "states.us-west-2.amazonaws.com",
      },
    },
  },
  "Outputs": {
    "ApiName": {
      "Value": "testApi",
    },
    "ClusterName": {
      "Value": {
        "Ref": "NetworkStackClusterName",
      },
    },
    "ContainerNames": {
      "Value": "testContainer",
    },
    "PipelineName": {
      "Value": {
        "Fn::Join": [
          "",
          [
            {
              "Ref": "rootStackName",
            },
            "-testApi-service-testExposedContainer-12345",
          ],
        ],
      },
    },
    "RootUrl": {
      "Value": {
        "Fn::GetAtt": [
          "Api",
          "ApiEndpoint",
        ],
      },
    },
    "ServiceName": {
      "Value": "testApi-service-testExposedContainer-12345",
    },
  },
  "Parameters": {
    "NetworkStackCloudMapNamespaceId": {
      "Type": "String",
    },
    "NetworkStackClusterName": {
      "Type": "String",
    },
    "NetworkStackSubnetIds": {
      "Type": "CommaDelimitedList",
    },
    "NetworkStackVpcCidrBlock": {
      "Type": "String",
    },
    "NetworkStackVpcId": {
      "Type": "String",
    },
    "NetworkStackVpcLinkId": {
      "Type": "String",
    },
    "ParamZipPath": {
      "Default": "",
      "Type": "String",
    },
    "awaiterS3Key": {
      "Default": "custom-resource-pipeline-awaiter-18.zip",
      "Type": "String",
    },
    "deploymentBucketName": {
      "Type": "String",
    },
    "domain": {
      "Default": "",
      "Type": "String",
    },
    "env": {
      "Type": "String",
    },
    "restrictAccess": {
      "AllowedValues": [
        "true",
        "false",
      ],
      "Default": "false",
      "Type": "String",
    },
    "rootStackName": {
      "Type": "String",
    },
    "storagepostsArn": {
      "Type": "String",
    },
    "storagepostsName": {
      "Type": "String",
    },
    "storagepostsStreamArn": {
      "Type": "String",
    },
  },
  "Resources": {
    "ANYIntegration": {
      "Properties": {
        "ApiId": {
          "Ref": "Api",
        },
        "ConnectionId": {
          "Ref": "NetworkStackVpcLinkId",
        },
        "ConnectionType": "VPC_LINK",
        "IntegrationMethod": "ANY",
        "IntegrationType": "HTTP_PROXY",
        "IntegrationUri": {
          "Fn::GetAtt": [
            "CloudmapService",
            "Arn",
          ],
        },
        "PayloadFormatVersion": "1.0",
      },
      "Type": "AWS::ApiGatewayV2::Integration",
    },
    "Api": {
      "Properties": {
        "CorsConfiguration": {
          "AllowHeaders": [
            "*",
          ],
          "AllowMethods": [
            "DELETE",
            "GET",
            "HEAD",
            "OPTIONS",
            "PATCH",
            "POST",
            "PUT",
          ],
          "AllowOrigins": [
            "*",
          ],
        },
        "Name": {
          "Fn::Join": [
            "",
            [
              {
                "Ref": "rootStackName",
              },
              "-testApi",
            ],
          ],
        },
        "ProtocolType": "HTTP",
      },
      "Type": "AWS::ApiGatewayV2::Api",
    },
    "ApiPipelineCodeBuildProject117EE1BE": {
      "Properties": {
        "Artifacts": {
          "Type": "CODEPIPELINE",
        },
        "Cache": {
          "Type": "NO_CACHE",
        },
        "EncryptionKey": "alias/aws/s3",
        "Environment": {
          "ComputeType": "BUILD_GENERAL1_SMALL",
          "Image": "aws/codebuild/standard:4.0",
          "ImagePullCredentialsType": "CODEBUILD",
          "PrivilegedMode": true,
          "Type": "LINUX_CONTAINER",
        },
        "ServiceRole": {
          "Fn::GetAtt": [
            "ApiPipelineCodeBuildProjectRoleCFB98631",
            "Arn",
          ],
        },
        "Source": {
          "Type": "CODEPIPELINE",
        },
      },
      "Type": "AWS::CodeBuild::Project",
    },
    "ApiPipelineCodeBuildProjectRoleCFB98631": {
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "codebuild.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
      },
      "Type": "AWS::IAM::Role",
    },
    "ApiPipelineCodeBuildProjectRoleDefaultPolicyAF1730E7": {
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:PutLogEvents",
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition",
                      },
                      ":logs:",
                      {
                        "Ref": "AWS::Region",
                      },
                      ":",
                      {
                        "Ref": "AWS::AccountId",
                      },
                      ":log-group:/aws/codebuild/",
                      {
                        "Ref": "ApiPipelineCodeBuildProject117EE1BE",
                      },
                    ],
                  ],
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition",
                      },
                      ":logs:",
                      {
                        "Ref": "AWS::Region",
                      },
                      ":",
                      {
                        "Ref": "AWS::AccountId",
                      },
                      ":log-group:/aws/codebuild/",
                      {
                        "Ref": "ApiPipelineCodeBuildProject117EE1BE",
                      },
                      ":*",
                    ],
                  ],
                },
              ],
            },
            {
              "Action": [
                "codebuild:CreateReportGroup",
                "codebuild:CreateReport",
                "codebuild:UpdateReport",
                "codebuild:BatchPutTestCases",
                "codebuild:BatchPutCodeCoverages",
              ],
              "Effect": "Allow",
              "Resource": {
                "Fn::Join": [
                  "",
                  [
                    "arn:",
                    {
                      "Ref": "AWS::Partition",
                    },
                    ":codebuild:",
                    {
                      "Ref": "AWS::Region",
                    },
                    ":",
                    {
                      "Ref": "AWS::AccountId",
                    },
                    ":report-group/",
                    {
                      "Ref": "ApiPipelineCodeBuildProject117EE1BE",
                    },
                    "-*",
                  ],
                ],
              },
            },
            {
              "Action": [
                "ecr:GetAuthorizationToken",
                "ecr:BatchGetImage",
                "ecr:GetDownloadUrlForLayer",
                "ecr:InitiateLayerUpload",
                "ecr:BatchCheckLayerAvailability",
                "ecr:UploadLayerPart",
                "ecr:CompleteLayerUpload",
                "ecr:PutImage",
              ],
              "Effect": "Allow",
              "Resource": "*",
            },
            {
              "Action": [
                "s3:GetObject*",
                "s3:GetBucket*",
                "s3:List*",
                "s3:DeleteObject*",
                "s3:PutObject",
                "s3:PutObjectLegalHold",
                "s3:PutObjectRetention",
                "s3:PutObjectTagging",
                "s3:PutObjectVersionTagging",
                "s3:Abort*",
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition",
                      },
                      ":s3:::",
                      {
                        "Ref": "deploymentBucketName",
                      },
                    ],
                  ],
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition",
                      },
                      ":s3:::",
                      {
                        "Ref": "deploymentBucketName",
                      },
                      "/*",
                    ],
                  ],
                },
              ],
            },
          ],
          "Version": "2012-10-17",
        },
        "PolicyName": "ApiPipelineCodeBuildProjectRoleDefaultPolicyAF1730E7",
        "Roles": [
          {
            "Ref": "ApiPipelineCodeBuildProjectRoleCFB98631",
          },
        ],
      },
      "Type": "AWS::IAM::Policy",
    },
    "ApiPipelinePipeline68596884": {
      "DependsOn": [
        "ApiPipelinePipelineRoleDefaultPolicyB3AD67CF",
        "ApiPipelinePipelineRole8C805448",
        "Service",
      ],
      "Properties": {
        "ArtifactStore": {
          "Location": {
            "Ref": "deploymentBucketName",
          },
          "Type": "S3",
        },
        "Name": {
          "Fn::Join": [
            "",
            [
              {
                "Ref": "rootStackName",
              },
              "-testApi-service-testExposedContainer-12345",
            ],
          ],
        },
        "RoleArn": {
          "Fn::GetAtt": [
            "ApiPipelinePipelineRole8C805448",
            "Arn",
          ],
        },
        "Stages": [
          {
            "Actions": [
              {
                "ActionTypeId": {
                  "Category": "Source",
                  "Owner": "AWS",
                  "Provider": "S3",
                  "Version": "1",
                },
                "Configuration": {
                  "S3Bucket": {
                    "Ref": "deploymentBucketName",
                  },
                  "S3ObjectKey": {
                    "Ref": "ParamZipPath",
                  },
                },
                "Name": "Source",
                "OutputArtifacts": [
                  {
                    "Name": "SourceArtifact",
                  },
                ],
                "RoleArn": {
                  "Fn::GetAtt": [
                    "ApiPipelinePipelineSourceCodePipelineActionRole59037A7A",
                    "Arn",
                  ],
                },
                "RunOrder": 1,
              },
            ],
            "Name": "Source",
          },
          {
            "Actions": [
              {
                "ActionTypeId": {
                  "Category": "Build",
                  "Owner": "AWS",
                  "Provider": "CodeBuild",
                  "Version": "1",
                },
                "Configuration": {
                  "EnvironmentVariables": {
                    "Fn::Join": [
                      "",
                      [
                        "[{"name":"AWS_ACCOUNT_ID","type":"PLAINTEXT","value":"",
                        {
                          "Ref": "AWS::AccountId",
                        },
                        ""}]",
                      ],
                    ],
                  },
                  "ProjectName": {
                    "Ref": "ApiPipelineCodeBuildProject117EE1BE",
                  },
                },
                "InputArtifacts": [
                  {
                    "Name": "SourceArtifact",
                  },
                ],
                "Name": "Build",
                "OutputArtifacts": [
                  {
                    "Name": "BuildArtifact",
                  },
                ],
                "RoleArn": {
                  "Fn::GetAtt": [
                    "ApiPipelinePipelineBuildCodePipelineActionRole04E6F13B",
                    "Arn",
                  ],
                },
                "RunOrder": 1,
              },
            ],
            "Name": "Build",
          },
          {
            "Actions": [
              {
                "ActionTypeId": {
                  "Category": "Invoke",
                  "Owner": "AWS",
                  "Provider": "Lambda",
                  "Version": "1",
                },
                "Configuration": {
                  "FunctionName": {
                    "Ref": "PreDeployLambdaF7CAA99F",
                  },
                },
                "Name": "Predeploy",
                "RoleArn": {
                  "Fn::GetAtt": [
                    "ApiPipelinePipelinePredeployCodePipelineActionRole387C06F4",
                    "Arn",
                  ],
                },
                "RunOrder": 1,
              },
            ],
            "Name": "Predeploy",
          },
          {
            "Actions": [
              {
                "ActionTypeId": {
                  "Category": "Deploy",
                  "Owner": "AWS",
                  "Provider": "ECS",
                  "Version": "1",
                },
                "Configuration": {
                  "ClusterName": {
                    "Ref": "NetworkStackClusterName",
                  },
                  "ServiceName": "testApi-service-testExposedContainer-12345",
                },
                "InputArtifacts": [
                  {
                    "Name": "BuildArtifact",
                  },
                ],
                "Name": "Deploy",
                "RoleArn": {
                  "Fn::GetAtt": [
                    "EcsDeployActionRole15B757E5",
                    "Arn",
                  ],
                },
                "RunOrder": 1,
              },
            ],
            "Name": "Deploy",
          },
        ],
      },
      "Type": "AWS::CodePipeline::Pipeline",
    },
    "ApiPipelinePipelineBuildCodePipelineActionRole04E6F13B": {
      "DependsOn": [
        "Service",
      ],
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "AWS": {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition",
                      },
                      ":iam::",
                      {
                        "Ref": "AWS::AccountId",
                      },
                      ":root",
                    ],
                  ],
                },
              },
            },
          ],
          "Version": "2012-10-17",
        },
      },
      "Type": "AWS::IAM::Role",
    },
    "ApiPipelinePipelineBuildCodePipelineActionRoleDefaultPolicy821C7A3A": {
      "DependsOn": [
        "Service",
      ],
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "codebuild:BatchGetBuilds",
                "codebuild:StartBuild",
                "codebuild:StopBuild",
              ],
              "Effect": "Allow",
              "Resource": {
                "Fn::GetAtt": [
                  "ApiPipelineCodeBuildProject117EE1BE",
                  "Arn",
                ],
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "PolicyName": "ApiPipelinePipelineBuildCodePipelineActionRoleDefaultPolicy821C7A3A",
        "Roles": [
          {
            "Ref": "ApiPipelinePipelineBuildCodePipelineActionRole04E6F13B",
          },
        ],
      },
      "Type": "AWS::IAM::Policy",
    },
    "ApiPipelinePipelinePredeployCodePipelineActionRole387C06F4": {
      "DependsOn": [
        "Service",
      ],
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "AWS": {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition",
                      },
                      ":iam::",
                      {
                        "Ref": "AWS::AccountId",
                      },
                      ":root",
                    ],
                  ],
                },
              },
            },
          ],
          "Version": "2012-10-17",
        },
      },
      "Type": "AWS::IAM::Role",
    },
    "ApiPipelinePipelinePredeployCodePipelineActionRoleDefaultPolicy715F96BC": {
      "DependsOn": [
        "Service",
      ],
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": "lambda:ListFunctions",
              "Effect": "Allow",
              "Resource": "*",
            },
            {
              "Action": "lambda:InvokeFunction",
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::GetAtt": [
                    "PreDeployLambdaF7CAA99F",
                    "Arn",
                  ],
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      {
                        "Fn::GetAtt": [
                          "PreDeployLambdaF7CAA99F",
                          "Arn",
                        ],
                      },
                      ":*",
                    ],
                  ],
                },
              ],
            },
          ],
          "Version": "2012-10-17",
        },
        "PolicyName": "ApiPipelinePipelinePredeployCodePipelineActionRoleDefaultPolicy715F96BC",
        "Roles": [
          {
            "Ref": "ApiPipelinePipelinePredeployCodePipelineActionRole387C06F4",
          },
        ],
      },
      "Type": "AWS::IAM::Policy",
    },
    "ApiPipelinePipelineRole8C805448": {
      "DependsOn": [
        "Service",
      ],
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "codepipeline.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
      },
      "Type": "AWS::IAM::Role",
    },
    "ApiPipelinePipelineRoleDefaultPolicyB3AD67CF": {
      "DependsOn": [
        "Service",
      ],
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "s3:GetObject*",
                "s3:GetBucket*",
                "s3:List*",
                "s3:DeleteObject*",
                "s3:PutObject",
                "s3:PutObjectLegalHold",
                "s3:PutObjectRetention",
                "s3:PutObjectTagging",
                "s3:PutObjectVersionTagging",
                "s3:Abort*",
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition",
                      },
                      ":s3:::",
                      {
                        "Ref": "deploymentBucketName",
                      },
                    ],
                  ],
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition",
                      },
                      ":s3:::",
                      {
                        "Ref": "deploymentBucketName",
                      },
                      "/*",
                    ],
                  ],
                },
              ],
            },
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Resource": {
                "Fn::GetAtt": [
                  "ApiPipelinePipelineSourceCodePipelineActionRole59037A7A",
                  "Arn",
                ],
              },
            },
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Resource": {
                "Fn::GetAtt": [
                  "ApiPipelinePipelineBuildCodePipelineActionRole04E6F13B",
                  "Arn",
                ],
              },
            },
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Resource": {
                "Fn::GetAtt": [
                  "ApiPipelinePipelinePredeployCodePipelineActionRole387C06F4",
                  "Arn",
                ],
              },
            },
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Resource": {
                "Fn::GetAtt": [
                  "EcsDeployActionRole15B757E5",
                  "Arn",
                ],
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "PolicyName": "ApiPipelinePipelineRoleDefaultPolicyB3AD67CF",
        "Roles": [
          {
            "Ref": "ApiPipelinePipelineRole8C805448",
          },
        ],
      },
      "Type": "AWS::IAM::Policy",
    },
    "ApiPipelinePipelineSourceCodePipelineActionRole59037A7A": {
      "DependsOn": [
        "Service",
      ],
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "AWS": {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition",
                      },
                      ":iam::",
                      {
                        "Ref": "AWS::AccountId",
                      },
                      ":root",
                    ],
                  ],
                },
              },
            },
          ],
          "Version": "2012-10-17",
        },
      },
      "Type": "AWS::IAM::Role",
    },
    "ApiPipelinePipelineSourceCodePipelineActionRoleDefaultPolicyE5B48B86": {
      "DependsOn": [
        "Service",
      ],
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "s3:GetObject*",
                "s3:GetBucket*",
                "s3:List*",
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition",
                      },
                      ":s3:::",
                      {
                        "Ref": "deploymentBucketName",
                      },
                    ],
                  ],
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition",
                      },
                      ":s3:::",
                      {
                        "Ref": "deploymentBucketName",
                      },
                      "/",
                      {
                        "Ref": "ParamZipPath",
                      },
                    ],
                  ],
                },
              ],
            },
            {
              "Action": [
                "s3:DeleteObject*",
                "s3:PutObject",
                "s3:PutObjectLegalHold",
                "s3:PutObjectRetention",
                "s3:PutObjectTagging",
                "s3:PutObjectVersionTagging",
                "s3:Abort*",
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition",
                      },
                      ":s3:::",
                      {
                        "Ref": "deploymentBucketName",
                      },
                    ],
                  ],
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition",
                      },
                      ":s3:::",
                      {
                        "Ref": "deploymentBucketName",
                      },
                      "/*",
                    ],
                  ],
                },
              ],
            },
          ],
          "Version": "2012-10-17",
        },
        "PolicyName": "ApiPipelinePipelineSourceCodePipelineActionRoleDefaultPolicyE5B48B86",
        "Roles": [
          {
            "Ref": "ApiPipelinePipelineSourceCodePipelineActionRole59037A7A",
          },
        ],
      },
      "Type": "AWS::IAM::Policy",
    },
    "Authorizer": {
      "Condition": "isAuthCondition",
      "Properties": {
        "ApiId": {
          "Ref": "Api",
        },
        "AuthorizerType": "JWT",
        "IdentitySource": [
          "$request.header.Authorization",
        ],
        "JwtConfiguration": {
          "Audience": [],
          "Issuer": {
            "Fn::Join": [
              "",
              [
                "https://cognito-idp.",
                {
                  "Ref": "AWS::Region",
                },
                ".amazonaws.com/",
              ],
            ],
          },
        },
        "Name": "testApiAuthorizer",
      },
      "Type": "AWS::ApiGatewayV2::Authorizer",
    },
    "AwaiterCustomCompleteHandler21A45EDC": {
      "DependsOn": [
        "AwaiterCustomCompleteHandlerServiceRoleDefaultPolicyB6596557",
        "AwaiterCustomCompleteHandlerServiceRoleFFF75973",
      ],
      "Properties": {
        "Code": {
          "ZipFile": "const { CloudFormation } = require('@aws-sdk/client-cloudformation');
const { CodePipeline } = require('@aws-sdk/client-codepipeline');

const stageName = 'Source';
const actionName = 'Source';

const codePipeline = new CodePipeline();
const cloudFormation = new CloudFormation();

exports.handler = async function({ RequestType, ResourceProperties, StackId }) {
  const { pipelineName, artifactBucketName, artifactKey, deploymentMechanism } = ResourceProperties;

  console.log('Properties', ResourceProperties);

  switch (RequestType) {
    case 'Delete':
      return { IsComplete: true };
    case 'Update':
      const [, StackName] = StackId.split('/');
      const { Stacks } = await cloudFormation.describeStacks({ StackName });
      const [{ StackStatus }] = Stacks;

      if (StackStatus.includes('ROLLBACK')) {
        return { IsComplete: true };
      }
  }

  let stages;

  try {
    const { pipeline } = await codePipeline.getPipeline({ name: pipelineName });

    ({ stages } = pipeline);
  } catch (error) {
    const { code } = error;

    switch (code) {
      case 'PipelineNotFoundException':
        console.warn(error);

        return {
          IsComplete: false,
        };
      default:
        throw error;
    }
  }

  const stage = stages.find(({ name }) => name === stageName);

  if (stage === undefined) {
    throw new Error(\`There is no stage named "\${stageName}" in the "\${pipelineName}" pipeline\`);
  }

  const action = stage.actions.find(({ name }) => name === actionName);

  if (action === undefined) {
    throw new Error(\`There is no action named "\${actionName}" in the "\${stageName}" stage of the "\${pipelineName}" pipeline\`);
  }

  const {
    configuration,
    configuration: { S3Bucket, S3ObjectKey },
  } = action;

  if (deploymentMechanism === 'FULLY_MANAGED') {
    if (S3Bucket !== artifactBucketName || S3ObjectKey !== artifactKey) {
      console.warn(
        \`Bucket "\${artifactBucketName}" and key "\${artifactKey}" dont match the "\${actionName}" action configuration \${JSON.stringify(
          configuration,
        )}\`,
      );

      return {
        IsComplete: false,
      };
    }
  }

  let execution;

  try {
    const { pipelineExecutionSummaries } = await codePipeline.listPipelineExecutions({ pipelineName });

    [execution] = pipelineExecutionSummaries;
  } catch (error) {
    console.warn(error);

    return {
      IsComplete: false,
    };
  }

  console.log(execution);

  const { status } = execution || {};

  let IsComplete = false;

  switch (status) {
    case 'Failed':
    case 'Stopped':
      throw new Error("The execution didn't succeed");
    case 'Succeeded':
      IsComplete = true;
  }

  return { IsComplete };
};
",
        },
        "Handler": "index.handler",
        "Role": {
          "Fn::GetAtt": [
            "AwaiterCustomCompleteHandlerServiceRoleFFF75973",
            "Arn",
          ],
        },
        "Runtime": "nodejs22.x",
        "Timeout": 15,
      },
      "Type": "AWS::Lambda::Function",
    },
    "AwaiterCustomCompleteHandlerServiceRoleDefaultPolicyB6596557": {
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "codepipeline:GetPipeline",
                "codepipeline:ListPipelineExecutions",
              ],
              "Effect": "Allow",
              "Resource": {
                "Fn::Join": [
                  "",
                  [
                    "arn:",
                    {
                      "Ref": "AWS::Partition",
                    },
                    ":codepipeline:",
                    {
                      "Ref": "AWS::Region",
                    },
                    ":",
                    {
                      "Ref": "AWS::AccountId",
                    },
                    ":",
                    {
                      "Ref": "ApiPipelinePipeline68596884",
                    },
                  ],
                ],
              },
            },
            {
              "Action": "cloudformation:DescribeStacks",
              "Effect": "Allow",
              "Resource": {
                "Ref": "AWS::StackId",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "PolicyName": "AwaiterCustomCompleteHandlerServiceRoleDefaultPolicyB6596557",
        "Roles": [
          {
            "Ref": "AwaiterCustomCompleteHandlerServiceRoleFFF75973",
          },
        ],
      },
      "Type": "AWS::IAM::Policy",
    },
    "AwaiterCustomCompleteHandlerServiceRoleFFF75973": {
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "lambda.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "ManagedPolicyArns": [
          {
            "Fn::Join": [
              "",
              [
                "arn:",
                {
                  "Ref": "AWS::Partition",
                },
                ":iam::aws:policy/service-role/AWSLambdaBasicExecutionRole",
              ],
            ],
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "AwaiterCustomEventHandler8B7CBA73": {
      "DependsOn": [
        "AwaiterCustomEventHandlerServiceRoleCC4D5DBF",
      ],
      "Properties": {
        "Code": {
          "ZipFile": "exports.handler = async function({ RequestType, PhysicalResourceId, ResourceProperties }) {
  switch (RequestType) {
    case 'Delete':
    case 'Update':
      return { PhysicalResourceId };
  }

  const { pipelineName } = ResourceProperties;

  const result = {
    PhysicalResourceId: \`pipelineawaiter-\${pipelineName}\`,
  };

  return result;
};
",
        },
        "Handler": "index.handler",
        "Role": {
          "Fn::GetAtt": [
            "AwaiterCustomEventHandlerServiceRoleCC4D5DBF",
            "Arn",
          ],
        },
        "Runtime": "nodejs22.x",
        "Timeout": 15,
      },
      "Type": "AWS::Lambda::Function",
    },
    "AwaiterCustomEventHandlerServiceRoleCC4D5DBF": {
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "lambda.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "ManagedPolicyArns": [
          {
            "Fn::Join": [
              "",
              [
                "arn:",
                {
                  "Ref": "AWS::Partition",
                },
                ":iam::aws:policy/service-role/AWSLambdaBasicExecutionRole",
              ],
            ],
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "AwaiterMyProviderframeworkisComplete18658065": {
      "DependsOn": [
        "AwaiterMyProviderframeworkisCompleteServiceRoleDefaultPolicyA36828FB",
        "AwaiterMyProviderframeworkisCompleteServiceRole2C6A7CF0",
      ],
      "Properties": {
        "Code": {
          "S3Bucket": {
            "Ref": "deploymentBucketName",
          },
          "S3Key": {
            "Ref": "awaiterS3Key",
          },
        },
        "Description": "AWS CDK resource provider framework - isComplete (testEcsStack/AwaiterMyProvider)",
        "Environment": {
          "Variables": {
            "USER_IS_COMPLETE_FUNCTION_ARN": {
              "Fn::GetAtt": [
                "AwaiterCustomCompleteHandler21A45EDC",
                "Arn",
              ],
            },
            "USER_ON_EVENT_FUNCTION_ARN": {
              "Fn::GetAtt": [
                "AwaiterCustomEventHandler8B7CBA73",
                "Arn",
              ],
            },
          },
        },
        "Handler": "framework.isComplete",
        "Role": {
          "Fn::GetAtt": [
            "AwaiterMyProviderframeworkisCompleteServiceRole2C6A7CF0",
            "Arn",
          ],
        },
        "Runtime": "nodejs18.x",
        "Timeout": 900,
      },
      "Type": "AWS::Lambda::Function",
    },
    "AwaiterMyProviderframeworkisCompleteServiceRole2C6A7CF0": {
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "lambda.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "ManagedPolicyArns": [
          {
            "Fn::Join": [
              "",
              [
                "arn:",
                {
                  "Ref": "AWS::Partition",
                },
                ":iam::aws:policy/service-role/AWSLambdaBasicExecutionRole",
              ],
            ],
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "AwaiterMyProviderframeworkisCompleteServiceRoleDefaultPolicyA36828FB": {
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": "lambda:InvokeFunction",
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::GetAtt": [
                    "AwaiterCustomEventHandler8B7CBA73",
                    "Arn",
                  ],
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      {
                        "Fn::GetAtt": [
                          "AwaiterCustomEventHandler8B7CBA73",
                          "Arn",
                        ],
                      },
                      ":*",
                    ],
                  ],
                },
              ],
            },
            {
              "Action": "lambda:InvokeFunction",
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::GetAtt": [
                    "AwaiterCustomCompleteHandler21A45EDC",
                    "Arn",
                  ],
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      {
                        "Fn::GetAtt": [
                          "AwaiterCustomCompleteHandler21A45EDC",
                          "Arn",
                        ],
                      },
                      ":*",
                    ],
                  ],
                },
              ],
            },
          ],
          "Version": "2012-10-17",
        },
        "PolicyName": "AwaiterMyProviderframeworkisCompleteServiceRoleDefaultPolicyA36828FB",
        "Roles": [
          {
            "Ref": "AwaiterMyProviderframeworkisCompleteServiceRole2C6A7CF0",
          },
        ],
      },
      "Type": "AWS::IAM::Policy",
    },
    "AwaiterMyProviderframeworkonEventB703D418": {
      "DependsOn": [
        "AwaiterMyProviderframeworkonEventServiceRoleDefaultPolicy41437CAE",
        "AwaiterMyProviderframeworkonEventServiceRole3DA490A7",
      ],
      "Properties": {
        "Code": {
          "S3Bucket": {
            "Ref": "deploymentBucketName",
          },
          "S3Key": {
            "Ref": "awaiterS3Key",
          },
        },
        "Description": "AWS CDK resource provider framework - onEvent (testEcsStack/AwaiterMyProvider)",
        "Environment": {
          "Variables": {
            "USER_IS_COMPLETE_FUNCTION_ARN": {
              "Fn::GetAtt": [
                "AwaiterCustomCompleteHandler21A45EDC",
                "Arn",
              ],
            },
            "USER_ON_EVENT_FUNCTION_ARN": {
              "Fn::GetAtt": [
                "AwaiterCustomEventHandler8B7CBA73",
                "Arn",
              ],
            },
            "WAITER_STATE_MACHINE_ARN": {
              "Ref": "AwaiterMyProviderwaiterstatemachineCF09BEC8",
            },
          },
        },
        "Handler": "framework.onEvent",
        "Role": {
          "Fn::GetAtt": [
            "AwaiterMyProviderframeworkonEventServiceRole3DA490A7",
            "Arn",
          ],
        },
        "Runtime": "nodejs18.x",
        "Timeout": 900,
      },
      "Type": "AWS::Lambda::Function",
    },
    "AwaiterMyProviderframeworkonEventServiceRole3DA490A7": {
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "lambda.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "ManagedPolicyArns": [
          {
            "Fn::Join": [
              "",
              [
                "arn:",
                {
                  "Ref": "AWS::Partition",
                },
                ":iam::aws:policy/service-role/AWSLambdaBasicExecutionRole",
              ],
            ],
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "AwaiterMyProviderframeworkonEventServiceRoleDefaultPolicy41437CAE": {
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": "lambda:InvokeFunction",
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::GetAtt": [
                    "AwaiterCustomEventHandler8B7CBA73",
                    "Arn",
                  ],
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      {
                        "Fn::GetAtt": [
                          "AwaiterCustomEventHandler8B7CBA73",
                          "Arn",
                        ],
                      },
                      ":*",
                    ],
                  ],
                },
              ],
            },
            {
              "Action": "lambda:InvokeFunction",
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::GetAtt": [
                    "AwaiterCustomCompleteHandler21A45EDC",
                    "Arn",
                  ],
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      {
                        "Fn::GetAtt": [
                          "AwaiterCustomCompleteHandler21A45EDC",
                          "Arn",
                        ],
                      },
                      ":*",
                    ],
                  ],
                },
              ],
            },
            {
              "Action": "states:StartExecution",
              "Effect": "Allow",
              "Resource": {
                "Ref": "AwaiterMyProviderwaiterstatemachineCF09BEC8",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "PolicyName": "AwaiterMyProviderframeworkonEventServiceRoleDefaultPolicy41437CAE",
        "Roles": [
          {
            "Ref": "AwaiterMyProviderframeworkonEventServiceRole3DA490A7",
          },
        ],
      },
      "Type": "AWS::IAM::Policy",
    },
    "AwaiterMyProviderframeworkonTimeoutCC4166A7": {
      "DependsOn": [
        "AwaiterMyProviderframeworkonTimeoutServiceRoleDefaultPolicyCB302F22",
        "AwaiterMyProviderframeworkonTimeoutServiceRole40F88C6A",
      ],
      "Properties": {
        "Code": {
          "S3Bucket": {
            "Ref": "deploymentBucketName",
          },
          "S3Key": {
            "Ref": "awaiterS3Key",
          },
        },
        "Description": "AWS CDK resource provider framework - onTimeout (testEcsStack/AwaiterMyProvider)",
        "Environment": {
          "Variables": {
            "USER_IS_COMPLETE_FUNCTION_ARN": {
              "Fn::GetAtt": [
                "AwaiterCustomCompleteHandler21A45EDC",
                "Arn",
              ],
            },
            "USER_ON_EVENT_FUNCTION_ARN": {
              "Fn::GetAtt": [
                "AwaiterCustomEventHandler8B7CBA73",
                "Arn",
              ],
            },
          },
        },
        "Handler": "framework.onTimeout",
        "Role": {
          "Fn::GetAtt": [
            "AwaiterMyProviderframeworkonTimeoutServiceRole40F88C6A",
            "Arn",
          ],
        },
        "Runtime": "nodejs18.x",
        "Timeout": 900,
      },
      "Type": "AWS::Lambda::Function",
    },
    "AwaiterMyProviderframeworkonTimeoutServiceRole40F88C6A": {
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "lambda.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "ManagedPolicyArns": [
          {
            "Fn::Join": [
              "",
              [
                "arn:",
                {
                  "Ref": "AWS::Partition",
                },
                ":iam::aws:policy/service-role/AWSLambdaBasicExecutionRole",
              ],
            ],
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "AwaiterMyProviderframeworkonTimeoutServiceRoleDefaultPolicyCB302F22": {
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": "lambda:InvokeFunction",
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::GetAtt": [
                    "AwaiterCustomEventHandler8B7CBA73",
                    "Arn",
                  ],
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      {
                        "Fn::GetAtt": [
                          "AwaiterCustomEventHandler8B7CBA73",
                          "Arn",
                        ],
                      },
                      ":*",
                    ],
                  ],
                },
              ],
            },
            {
              "Action": "lambda:InvokeFunction",
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::GetAtt": [
                    "AwaiterCustomCompleteHandler21A45EDC",
                    "Arn",
                  ],
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      {
                        "Fn::GetAtt": [
                          "AwaiterCustomCompleteHandler21A45EDC",
                          "Arn",
                        ],
                      },
                      ":*",
                    ],
                  ],
                },
              ],
            },
          ],
          "Version": "2012-10-17",
        },
        "PolicyName": "AwaiterMyProviderframeworkonTimeoutServiceRoleDefaultPolicyCB302F22",
        "Roles": [
          {
            "Ref": "AwaiterMyProviderframeworkonTimeoutServiceRole40F88C6A",
          },
        ],
      },
      "Type": "AWS::IAM::Policy",
    },
    "AwaiterMyProviderwaiterstatemachineCF09BEC8": {
      "DependsOn": [
        "AwaiterMyProviderwaiterstatemachineRoleDefaultPolicy17602DC1",
        "AwaiterMyProviderwaiterstatemachineRoleD2CF7945",
      ],
      "Properties": {
        "DefinitionString": {
          "Fn::Join": [
            "",
            [
              "{"StartAt":"framework-isComplete-task","States":{"framework-isComplete-task":{"End":true,"Retry":[{"ErrorEquals":["States.ALL"],"IntervalSeconds":10,"MaxAttempts":180,"BackoffRate":1}],"Catch":[{"ErrorEquals":["States.ALL"],"Next":"framework-onTimeout-task"}],"Type":"Task","Resource":"",
              {
                "Fn::GetAtt": [
                  "AwaiterMyProviderframeworkisComplete18658065",
                  "Arn",
                ],
              },
              ""},"framework-onTimeout-task":{"End":true,"Type":"Task","Resource":"",
              {
                "Fn::GetAtt": [
                  "AwaiterMyProviderframeworkonTimeoutCC4166A7",
                  "Arn",
                ],
              },
              ""}}}",
            ],
          ],
        },
        "RoleArn": {
          "Fn::GetAtt": [
            "AwaiterMyProviderwaiterstatemachineRoleD2CF7945",
            "Arn",
          ],
        },
      },
      "Type": "AWS::StepFunctions::StateMachine",
    },
    "AwaiterMyProviderwaiterstatemachineRoleD2CF7945": {
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": {
                  "Fn::FindInMap": [
                    "ServiceprincipalMap",
                    {
                      "Ref": "AWS::Region",
                    },
                    "states",
                  ],
                },
              },
            },
          ],
          "Version": "2012-10-17",
        },
      },
      "Type": "AWS::IAM::Role",
    },
    "AwaiterMyProviderwaiterstatemachineRoleDefaultPolicy17602DC1": {
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": "lambda:InvokeFunction",
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::GetAtt": [
                    "AwaiterMyProviderframeworkisComplete18658065",
                    "Arn",
                  ],
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      {
                        "Fn::GetAtt": [
                          "AwaiterMyProviderframeworkisComplete18658065",
                          "Arn",
                        ],
                      },
                      ":*",
                    ],
                  ],
                },
              ],
            },
            {
              "Action": "lambda:InvokeFunction",
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::GetAtt": [
                    "AwaiterMyProviderframeworkonTimeoutCC4166A7",
                    "Arn",
                  ],
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      {
                        "Fn::GetAtt": [
                          "AwaiterMyProviderframeworkonTimeoutCC4166A7",
                          "Arn",
                        ],
                      },
                      ":*",
                    ],
                  ],
                },
              ],
            },
          ],
          "Version": "2012-10-17",
        },
        "PolicyName": "AwaiterMyProviderwaiterstatemachineRoleDefaultPolicy17602DC1",
        "Roles": [
          {
            "Ref": "AwaiterMyProviderwaiterstatemachineRoleD2CF7945",
          },
        ],
      },
      "Type": "AWS::IAM::Policy",
    },
    "CloudmapService": {
      "Properties": {
        "DnsConfig": {
          "DnsRecords": [
            {
              "TTL": 60,
              "Type": "SRV",
            },
          ],
          "NamespaceId": {
            "Ref": "NetworkStackCloudMapNamespaceId",
          },
          "RoutingPolicy": "MULTIVALUE",
        },
        "Name": "testApi",
      },
      "Type": "AWS::ServiceDiscovery::Service",
    },
    "DefaultRoute": {
      "Properties": {
        "ApiId": {
          "Ref": "Api",
        },
        "AuthorizationScopes": [],
        "AuthorizationType": {
          "Fn::If": [
            "isAuthCondition",
            "JWT",
            "NONE",
          ],
        },
        "AuthorizerId": {
          "Fn::If": [
            "isAuthCondition",
            {
              "Ref": "Authorizer",
            },
            "",
          ],
        },
        "RouteKey": "$default",
        "Target": {
          "Fn::Join": [
            "",
            [
              "integrations/",
              {
                "Ref": "ANYIntegration",
              },
            ],
          ],
        },
      },
      "Type": "AWS::ApiGatewayV2::Route",
    },
    "DeploymentAwaiter": {
      "DeletionPolicy": "Delete",
      "Properties": {
        "ServiceToken": {
          "Fn::GetAtt": [
            "AwaiterMyProviderframeworkonEventB703D418",
            "Arn",
          ],
        },
        "artifactBucketName": {
          "Ref": "deploymentBucketName",
        },
        "artifactKey": {
          "Ref": "ParamZipPath",
        },
        "pipelineName": {
          "Ref": "ApiPipelinePipeline68596884",
        },
      },
      "Type": "AWS::CloudFormation::CustomResource",
      "UpdateReplacePolicy": "Delete",
    },
    "EcsDeployActionRole15B757E5": {
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "AWS": {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition",
                      },
                      ":iam::",
                      {
                        "Ref": "AWS::AccountId",
                      },
                      ":root",
                    ],
                  ],
                },
              },
            },
          ],
          "Version": "2012-10-17",
        },
      },
      "Type": "AWS::IAM::Role",
    },
    "EcsDeployActionRoleDefaultPolicy0BE60A75": {
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": "ecs:TagResource",
              "Effect": "Allow",
              "Resource": "*",
            },
            {
              "Action": [
                "ecs:DescribeServices",
                "ecs:DescribeTaskDefinition",
                "ecs:DescribeTasks",
                "ecs:ListTasks",
                "ecs:RegisterTaskDefinition",
                "ecs:UpdateService",
              ],
              "Effect": "Allow",
              "Resource": "*",
            },
            {
              "Action": "iam:PassRole",
              "Condition": {
                "StringEqualsIfExists": {
                  "iam:PassedToService": [
                    "ec2.amazonaws.com",
                    "ecs-tasks.amazonaws.com",
                  ],
                },
              },
              "Effect": "Allow",
              "Resource": "*",
            },
            {
              "Action": [
                "s3:GetObject*",
                "s3:GetBucket*",
                "s3:List*",
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition",
                      },
                      ":s3:::",
                      {
                        "Ref": "deploymentBucketName",
                      },
                    ],
                  ],
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition",
                      },
                      ":s3:::",
                      {
                        "Ref": "deploymentBucketName",
                      },
                      "/*",
                    ],
                  ],
                },
              ],
            },
          ],
          "Version": "2012-10-17",
        },
        "PolicyName": "EcsDeployActionRoleDefaultPolicy0BE60A75",
        "Roles": [
          {
            "Ref": "EcsDeployActionRole15B757E5",
          },
        ],
      },
      "Type": "AWS::IAM::Policy",
    },
    "OptionsRoute": {
      "Properties": {
        "ApiId": {
          "Ref": "Api",
        },
        "RouteKey": "OPTIONS /{proxy+}",
        "Target": {
          "Fn::Join": [
            "",
            [
              "integrations/",
              {
                "Ref": "ANYIntegration",
              },
            ],
          ],
        },
      },
      "Type": "AWS::ApiGatewayV2::Route",
    },
    "PreDeployLambdaF7CAA99F": {
      "DependsOn": [
        "PreDeployLambdaServiceRoleDefaultPolicyD9F42A87",
        "PreDeployLambdaServiceRole87EE44C9",
      ],
      "Properties": {
        "Code": {
          "ZipFile": "const { CodePipeline } = require('@aws-sdk/client-codepipeline');
const { ECS } = require('@aws-sdk/client-ecs');

const codepipeline = new CodePipeline();
const ecs = new ECS();

const { DESIRED_COUNT: desiredCountStr, CLUSTER_NAME: cluster, SERVICE_NAME: service } = process.env;

const desiredCount = parseInt(desiredCountStr, 10);

exports.handler = async function({ 'CodePipeline.job': { id: jobId } }) {
  await ecs.updateService({
    service,
    cluster,
    desiredCount,
  });

  return await codepipeline.putJobSuccessResult({ jobId });
};
",
        },
        "Environment": {
          "Variables": {
            "CLUSTER_NAME": {
              "Ref": "NetworkStackClusterName",
            },
            "DESIRED_COUNT": "1",
            "SERVICE_NAME": "testApi-service-testExposedContainer-12345",
          },
        },
        "Handler": "index.handler",
        "Role": {
          "Fn::GetAtt": [
            "PreDeployLambdaServiceRole87EE44C9",
            "Arn",
          ],
        },
        "Runtime": "nodejs22.x",
        "Timeout": 15,
      },
      "Type": "AWS::Lambda::Function",
    },
    "PreDeployLambdaServiceRole87EE44C9": {
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "lambda.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "ManagedPolicyArns": [
          {
            "Fn::Join": [
              "",
              [
                "arn:",
                {
                  "Ref": "AWS::Partition",
                },
                ":iam::aws:policy/service-role/AWSLambdaBasicExecutionRole",
              ],
            ],
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "PreDeployLambdaServiceRoleDefaultPolicyD9F42A87": {
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": "ecs:UpdateService",
              "Effect": "Allow",
              "Resource": {
                "Ref": "Service",
              },
            },
            {
              "Action": [
                "codepipeline:PutJobSuccessResult",
                "codepipeline:PutJobFailureResult",
              ],
              "Effect": "Allow",
              "Resource": "*",
            },
          ],
          "Version": "2012-10-17",
        },
        "PolicyName": "PreDeployLambdaServiceRoleDefaultPolicyD9F42A87",
        "Roles": [
          {
            "Ref": "PreDeployLambdaServiceRole87EE44C9",
          },
        ],
      },
      "Type": "AWS::IAM::Policy",
    },
    "Service": {
      "Properties": {
        "Cluster": {
          "Ref": "NetworkStackClusterName",
        },
        "DesiredCount": 1,
        "LaunchType": "FARGATE",
        "NetworkConfiguration": {
          "AwsvpcConfiguration": {
            "AssignPublicIp": "ENABLED",
            "SecurityGroups": [
              {
                "Fn::GetAtt": [
                  "ServiceSG",
                  "GroupId",
                ],
              },
            ],
            "Subnets": {
              "Ref": "NetworkStackSubnetIds",
            },
          },
        },
        "ServiceName": "testApi-service-testExposedContainer-12345",
        "ServiceRegistries": [
          {
            "ContainerName": "testExposedContainer",
            "ContainerPort": 12345,
            "RegistryArn": {
              "Fn::GetAtt": [
                "CloudmapService",
                "Arn",
              ],
            },
          },
        ],
        "TaskDefinition": {
          "Ref": "TaskDefinition",
        },
      },
      "Type": "AWS::ECS::Service",
    },
    "ServiceSG": {
      "Properties": {
        "GroupDescription": "Service SecurityGroup",
        "SecurityGroupEgress": [
          {
            "CidrIp": "0.0.0.0/0",
            "Description": "Allow all outbound traffic by default",
            "IpProtocol": "-1",
          },
        ],
        "SecurityGroupIngress": [],
        "VpcId": {
          "Ref": "NetworkStackVpcId",
        },
      },
      "Type": "AWS::EC2::SecurityGroup",
    },
    "Stage": {
      "Properties": {
        "ApiId": {
          "Ref": "Api",
        },
        "AutoDeploy": true,
        "StageName": "$default",
      },
      "Type": "AWS::ApiGatewayV2::Stage",
    },
    "TaskDefinition": {
      "Properties": {
        "ContainerDefinitions": [
          {
            "Command": [],
            "EntryPoint": [],
            "Essential": true,
            "HealthCheck": {
              "Command": [
                "CMD-SHELL",
                "foo",
              ],
              "Interval": 30,
              "Retries": 3,
              "StartPeriod": 0,
              "Timeout": 5,
            },
            "Image": "testImage",
            "LogConfiguration": {
              "LogDriver": "awslogs",
              "Options": {
                "awslogs-group": {
                  "Ref": "testContainerContainerLogGroupE42C53EF",
                },
                "awslogs-region": {
                  "Ref": "AWS::Region",
                },
                "awslogs-stream-prefix": "ecs",
              },
            },
            "Name": "testContainer",
          },
        ],
        "Cpu": "512",
        "ExecutionRoleArn": {
          "Fn::GetAtt": [
            "TaskDefinitionExecutionRole8D61C2FB",
            "Arn",
          ],
        },
        "Family": {
          "Fn::Join": [
            "",
            [
              {
                "Ref": "rootStackName",
              },
              "-testApi",
            ],
          ],
        },
        "Memory": "1024",
        "NetworkMode": "awsvpc",
        "RequiresCompatibilities": [
          "FARGATE",
        ],
        "TaskRoleArn": {
          "Fn::GetAtt": [
            "TaskDefinitionTaskRoleFD40A61D",
            "Arn",
          ],
        },
      },
      "Type": "AWS::ECS::TaskDefinition",
    },
    "TaskDefinitionExecutionRole8D61C2FB": {
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "ecs-tasks.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
      },
      "Type": "AWS::IAM::Role",
    },
    "TaskDefinitionExecutionRoleDefaultPolicy1F3406F5": {
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "logs:CreateLogStream",
                "logs:PutLogEvents",
              ],
              "Effect": "Allow",
              "Resource": {
                "Fn::Join": [
                  "",
                  [
                    "arn:",
                    {
                      "Ref": "AWS::Partition",
                    },
                    ":logs:",
                    {
                      "Ref": "AWS::Region",
                    },
                    ":",
                    {
                      "Ref": "AWS::AccountId",
                    },
                    ":log-group:",
                    {
                      "Ref": "testContainerContainerLogGroupE42C53EF",
                    },
                    ":*",
                  ],
                ],
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "PolicyName": "TaskDefinitionExecutionRoleDefaultPolicy1F3406F5",
        "Roles": [
          {
            "Ref": "TaskDefinitionExecutionRole8D61C2FB",
          },
        ],
      },
      "Type": "AWS::IAM::Policy",
    },
    "TaskDefinitionTaskRoleDefaultPolicy282E8624": {
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "dynamodb:Get*",
                "dynamodb:BatchGetItem",
                "dynamodb:List*",
                "dynamodb:Describe*",
                "dynamodb:Scan",
                "dynamodb:Query",
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Ref": "storagepostsArn",
                },
                {
                  "Fn::Join": [
                    "/",
                    [
                      {
                        "Ref": "storagepostsArn",
                      },
                      "index/*",
                    ],
                  ],
                },
              ],
            },
            {
              "Action": "s3:ListBucket",
              "Effect": "Allow",
            },
          ],
          "Version": "2012-10-17",
        },
        "PolicyName": "TaskDefinitionTaskRoleDefaultPolicy282E8624",
        "Roles": [
          {
            "Ref": "TaskDefinitionTaskRoleFD40A61D",
          },
        ],
      },
      "Type": "AWS::IAM::Policy",
    },
    "TaskDefinitionTaskRoleFD40A61D": {
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "ecs-tasks.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
      },
      "Type": "AWS::IAM::Role",
    },
    "testContainerContainerLogGroupE42C53EF": {
      "DeletionPolicy": "Delete",
      "Properties": {
        "LogGroupName": {
          "Fn::Join": [
            "",
            [
              "/ecs/",
              {
                "Ref": "rootStackName",
              },
              "-testApi-testContainer",
            ],
          ],
        },
        "RetentionInDays": 30,
      },
      "Type": "AWS::Logs::LogGroup",
      "UpdateReplacePolicy": "Delete",
    },
  },
}
`;
